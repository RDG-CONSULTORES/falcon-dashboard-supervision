<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Falcon Miniapp - Dashboard Funcional</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { opacity: 0.9; margin: 10px 0; }
        .card { background: white; padding: 25px; margin: 20px 0; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric { text-align: center; padding: 25px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .metric-value { font-size: 2.2em; font-weight: bold; margin-bottom: 5px; }
        .metric-label { opacity: 0.9; font-size: 0.9em; }
        .chart-container { position: relative; height: 450px; margin: 20px 0; background: white; border-radius: 8px; padding: 15px; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid; }
        .status.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .status.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .status.warning { background: #fff3cd; color: #856404; border-color: #ffc107; }
        .status.info { background: #d1ecf1; color: #0c5460; border-color: #17a2b8; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button:active { transform: translateY(0); }
        .loading { text-align: center; color: #6c757d; padding: 40px; }
        .loading::after { content: '...'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: #6c757d; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .25em 0 0 #6c757d, .5em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .25em 0 0 #6c757d, .5em 0 0 #6c757d; } }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        .endpoint-test { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 6px; }
        .endpoint-name { font-weight: 500; }
        .endpoint-status { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500; }
        .endpoint-status.success { background: #28a745; color: white; }
        .endpoint-status.error { background: #dc3545; color: white; }
        .endpoint-status.testing { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Falcon Miniapp Bot v4.0</h1>
            <p>Dashboard Funcional - Con Datos Reales</p>
            <p>Estado: <span id="server-status">Verificando...</span> | Registros: <strong>400,447</strong></p>
        </div>
        
        <div class="card">
            <h2>üìä Estado del Sistema</h2>
            <div id="system-status" class="loading">Verificando componentes del sistema</div>
        </div>
        
        <div class="card">
            <h2>üìà M√©tricas Basadas en Datos Geogr√°ficos</h2>
            <div id="metrics-container" class="metrics">
                <div class="loading" style="grid-column: 1 / -1;">Cargando m√©tricas de coordenadas</div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="card">
                <h2>üó∫Ô∏è Top Sucursales por Performance</h2>
                <div class="chart-container">
                    <canvas id="branchesChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>üìç Distribuci√≥n Geogr√°fica</h2>
                <div class="chart-container">
                    <canvas id="geoChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìä Mapa de Calor de Performance</h2>
            <div class="chart-container">
                <canvas id="heatmapChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>üß™ Verificaci√≥n de APIs Funcionales</h2>
            <div class="btn-group">
                <button onclick="testWorkingEndpoints()">üîÑ Probar APIs Funcionales</button>
                <button onclick="loadDashboardData()">üìä Recargar Dashboard</button>
                <button onclick="loadGeographicAnalysis()">üó∫Ô∏è An√°lisis Geogr√°fico</button>
                <button onclick="loadPerformanceData()">üìà Datos de Performance</button>
            </div>
            <div id="api-tests"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5002';
        let charts = {};
        
        // Test system health
        async function checkSystemHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/health/`);
                const data = await response.json();
                
                const statusDiv = document.getElementById('system-status');
                const serverStatus = document.getElementById('server-status');
                
                if (response.ok) {
                    serverStatus.innerHTML = `<span style="color: #28a745">‚úÖ ${data.status.toUpperCase()}</span>`;
                    
                    let componentStatus = '';
                    Object.entries(data.components).forEach(([name, status]) => {
                        const icon = status === 'healthy' ? '‚úÖ' : '‚ö†Ô∏è';
                        const statusClass = status === 'healthy' ? 'success' : 'warning';
                        
                        componentStatus += `
                            <div class="status ${statusClass}">
                                ${icon} <strong>${name.toUpperCase()}</strong>: ${status}
                            </div>
                        `;
                    });
                    
                    statusDiv.innerHTML = componentStatus;
                } else {
                    serverStatus.innerHTML = `<span style="color: #dc3545">‚ùå ERROR</span>`;
                    statusDiv.innerHTML = `<div class="status error">‚ùå Error del sistema</div>`;
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML = `<span style="color: #dc3545">‚ùå OFFLINE</span>`;
                document.getElementById('system-status').innerHTML = 
                    `<div class="status error">‚ùå No se puede conectar al servidor: ${error.message}</div>`;
            }
        }
        
        // Load metrics from coordinate data
        async function loadMetrics() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/geo/coordinates?year=2025&limit=50`);
                const data = await response.json();
                
                const metricsContainer = document.getElementById('metrics-container');
                
                if (response.ok && data.success && data.data.length > 0) {
                    // Calculate metrics from coordinate data
                    const coordinates = data.data;
                    const totalSupervisions = coordinates.reduce((sum, item) => sum + item.total_supervisiones, 0);
                    const avgPercentage = coordinates.reduce((sum, item) => sum + parseFloat(item.promedio_porcentaje), 0) / coordinates.length;
                    const uniqueStates = [...new Set(coordinates.map(item => item.estado))].length;
                    const excellentBranches = coordinates.filter(item => item.categoria_performance === 'excelente').length;
                    
                    metricsContainer.innerHTML = `
                        <div class="metric">
                            <div class="metric-value">${avgPercentage.toFixed(1)}%</div>
                            <div class="metric-label">Promedio General</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${totalSupervisions.toLocaleString()}</div>
                            <div class="metric-label">Total Supervisiones</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${coordinates.length}</div>
                            <div class="metric-label">Sucursales Activas</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${uniqueStates}</div>
                            <div class="metric-label">Estados</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${excellentBranches}</div>
                            <div class="metric-label">Performance Excelente</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">2025</div>
                            <div class="metric-label">A√±o de Datos</div>
                        </div>
                    `;
                    
                    // Load charts
                    loadCharts(coordinates);
                } else {
                    metricsContainer.innerHTML = `
                        <div class="status warning" style="grid-column: 1 / -1;">
                            ‚ö†Ô∏è No se pudieron cargar las coordenadas para calcular m√©tricas
                        </div>
                    `;
                }
                
            } catch (error) {
                document.getElementById('metrics-container').innerHTML = 
                    `<div class="status error" style="grid-column: 1 / -1;">‚ùå Error cargando m√©tricas: ${error.message}</div>`;
            }
        }
        
        // Load charts with coordinate data
        function loadCharts(coordinates) {
            // Top branches chart
            const topBranches = coordinates
                .sort((a, b) => parseFloat(b.promedio_porcentaje) - parseFloat(a.promedio_porcentaje))
                .slice(0, 10);
                
            const ctx1 = document.getElementById('branchesChart').getContext('2d');
            if (charts.branches) charts.branches.destroy();
            
            charts.branches = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: topBranches.map(item => item.sucursal),
                    datasets: [{
                        label: 'Performance (%)',
                        data: topBranches.map(item => parseFloat(item.promedio_porcentaje)),
                        backgroundColor: 'rgba(245, 87, 108, 0.8)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Top 10 Sucursales por Performance' }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                    }
                }
            });
            
            // Geographic distribution
            const stateDistribution = {};
            coordinates.forEach(item => {
                if (!stateDistribution[item.estado]) {
                    stateDistribution[item.estado] = 0;
                }
                stateDistribution[item.estado]++;
            });
            
            const ctx2 = document.getElementById('geoChart').getContext('2d');
            if (charts.geo) charts.geo.destroy();
            
            charts.geo = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stateDistribution),
                    datasets: [{
                        data: Object.values(stateDistribution),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Distribuci√≥n de Sucursales por Estado' }
                    }
                }
            });
            
            // Performance heatmap simulation
            const performanceCategories = {};
            coordinates.forEach(item => {
                if (!performanceCategories[item.categoria_performance]) {
                    performanceCategories[item.categoria_performance] = 0;
                }
                performanceCategories[item.categoria_performance]++;
            });
            
            const ctx3 = document.getElementById('heatmapChart').getContext('2d');
            if (charts.heatmap) charts.heatmap.destroy();
            
            charts.heatmap = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: Object.keys(performanceCategories),
                    datasets: [{
                        label: 'N√∫mero de Sucursales',
                        data: Object.values(performanceCategories),
                        backgroundColor: [
                            '#0d47a1', '#1976d2', '#42a5f5', '#90caf9'
                        ],
                        borderColor: '#0d47a1',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Distribuci√≥n por Categor√≠a de Performance' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Test working endpoints
        async function testWorkingEndpoints() {
            const testsDiv = document.getElementById('api-tests');
            testsDiv.innerHTML = '<div class="loading">Probando endpoints funcionales</div>';
            
            const endpoints = [
                { url: '/api/v1/health/', name: 'Health Check' },
                { url: '/api/v1/geo/coordinates?year=2025&limit=5', name: 'Coordenadas Geogr√°ficas' },
                { url: '/api/v1/analytics/performance/states?year=2025', name: 'Performance Estados' },
                { url: '/api/v1/analytics/performance/branches?year=2025', name: 'Performance Sucursales' },
                { url: '/api/v1/analytics/trends?year=2025', name: 'Tendencias' },
                { url: '/api/v1/analytics/ranking?year=2025', name: 'Rankings' },
            ];
            
            testsDiv.innerHTML = '';
            
            for (const endpoint of endpoints) {
                const testDiv = document.createElement('div');
                testDiv.className = 'endpoint-test';
                testDiv.innerHTML = `
                    <span class="endpoint-name">${endpoint.name}</span>
                    <span class="endpoint-status testing">Probando...</span>
                `;
                testsDiv.appendChild(testDiv);
                
                try {
                    const response = await fetch(`${API_BASE}${endpoint.url}`);
                    const statusSpan = testDiv.querySelector('.endpoint-status');
                    
                    if (response.ok) {
                        const data = await response.json();
                        statusSpan.className = 'endpoint-status success';
                        statusSpan.textContent = '‚úÖ OK';
                        
                        if (data.data && Array.isArray(data.data)) {
                            statusSpan.textContent += ` (${data.data.length} items)`;
                        } else if (data.components) {
                            statusSpan.textContent = `‚úÖ ${data.status}`;
                        }
                    } else {
                        statusSpan.className = 'endpoint-status error';
                        statusSpan.textContent = `‚ùå ${response.status}`;
                    }
                } catch (error) {
                    const statusSpan = testDiv.querySelector('.endpoint-status');
                    statusSpan.className = 'endpoint-status error';
                    statusSpan.textContent = '‚ùå Error';
                }
            }
        }
        
        // Load geographic analysis
        async function loadGeographicAnalysis() {
            const testsDiv = document.getElementById('api-tests');
            testsDiv.innerHTML = '<div class="loading">Cargando an√°lisis geogr√°fico detallado</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/geo/coordinates?year=2025&limit=100`);
                const data = await response.json();
                
                if (response.ok && data.success && data.data.length > 0) {
                    const coordinates = data.data;
                    const stateStats = {};
                    
                    coordinates.forEach(item => {
                        const state = item.estado;
                        if (!stateStats[state]) {
                            stateStats[state] = {
                                branches: 0,
                                totalSupervisions: 0,
                                totalPercentage: 0,
                                excellent: 0
                            };
                        }
                        
                        stateStats[state].branches++;
                        stateStats[state].totalSupervisions += item.total_supervisiones;
                        stateStats[state].totalPercentage += parseFloat(item.promedio_porcentaje);
                        if (item.categoria_performance === 'excelente') {
                            stateStats[state].excellent++;
                        }
                    });
                    
                    let analysisHtml = '<h3>üó∫Ô∏è An√°lisis Geogr√°fico Detallado:</h3>';
                    
                    Object.entries(stateStats).forEach(([state, stats]) => {
                        const avgPercentage = (stats.totalPercentage / stats.branches).toFixed(1);
                        const excellentRate = ((stats.excellent / stats.branches) * 100).toFixed(1);
                        
                        analysisHtml += `
                            <div class="status info">
                                <strong>${state}</strong>:<br>
                                ‚Ä¢ ${stats.branches} sucursales<br>
                                ‚Ä¢ ${stats.totalSupervisions.toLocaleString()} supervisiones<br>
                                ‚Ä¢ ${avgPercentage}% promedio performance<br>
                                ‚Ä¢ ${excellentRate}% con performance excelente
                            </div>
                        `;
                    });
                    
                    testsDiv.innerHTML = analysisHtml;
                } else {
                    testsDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è No se pudieron cargar datos geogr√°ficos</div>';
                }
            } catch (error) {
                testsDiv.innerHTML = `<div class="status error">‚ùå Error en an√°lisis geogr√°fico: ${error.message}</div>`;
            }
        }
        
        // Load performance data
        async function loadPerformanceData() {
            const testsDiv = document.getElementById('api-tests');
            testsDiv.innerHTML = '<div class="loading">Cargando datos de performance</div>';
            
            let resultsHtml = '<h3>üìà Datos de Performance Disponibles:</h3>';
            
            try {
                // Test trends
                const trendsResponse = await fetch(`${API_BASE}/api/v1/analytics/trends?year=2025`);
                if (trendsResponse.ok) {
                    const trendsData = await trendsResponse.json();
                    if (trendsData.success && trendsData.data.length > 0) {
                        resultsHtml += '<div class="status success">‚úÖ Tendencias temporales: Disponibles</div>';
                        trendsData.data.forEach(trend => {
                            resultsHtml += `<div class="status info">‚Ä¢ Q${trend.quarter}: ${trend.promedio}% promedio, ${trend.total_supervisiones} supervisiones</div>`;
                        });
                    }
                }
                
                // Test rankings
                const rankingResponse = await fetch(`${API_BASE}/api/v1/analytics/ranking?year=2025`);
                if (rankingResponse.ok) {
                    const rankingData = await rankingResponse.json();
                    if (rankingData.success && rankingData.data.length > 0) {
                        resultsHtml += '<div class="status success">‚úÖ Rankings: Disponibles</div>';
                        resultsHtml += `<div class="status info">‚Ä¢ ${rankingData.data.length} elementos en el ranking</div>`;
                    }
                }
                
                testsDiv.innerHTML = resultsHtml;
                
            } catch (error) {
                testsDiv.innerHTML = `<div class="status error">‚ùå Error cargando performance: ${error.message}</div>`;
            }
        }
        
        // Load all dashboard data
        function loadDashboardData() {
            checkSystemHealth();
            loadMetrics();
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Falcon Miniapp Dashboard Funcional iniciado');
            loadDashboardData();
        });
    </script>
</body>
</html>