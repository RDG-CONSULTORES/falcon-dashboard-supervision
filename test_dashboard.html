<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Falcon Miniapp - Dashboard de Verificaci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { opacity: 0.9; margin: 10px 0; }
        .card { background: white; padding: 25px; margin: 20px 0; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric { text-align: center; padding: 25px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .metric-value { font-size: 2.2em; font-weight: bold; margin-bottom: 5px; }
        .metric-label { opacity: 0.9; font-size: 0.9em; }
        .chart-container { position: relative; height: 450px; margin: 20px 0; background: white; border-radius: 8px; padding: 15px; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid; }
        .status.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .status.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .status.warning { background: #fff3cd; color: #856404; border-color: #ffc107; }
        .status.info { background: #d1ecf1; color: #0c5460; border-color: #17a2b8; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button:active { transform: translateY(0); }
        .loading { text-align: center; color: #6c757d; padding: 40px; }
        .loading::after { content: '...'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: #6c757d; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .25em 0 0 #6c757d, .5em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .25em 0 0 #6c757d, .5em 0 0 #6c757d; } }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        .endpoint-test { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 6px; }
        .endpoint-name { font-weight: 500; }
        .endpoint-status { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500; }
        .endpoint-status.success { background: #28a745; color: white; }
        .endpoint-status.error { background: #dc3545; color: white; }
        .endpoint-status.testing { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Falcon Miniapp Bot v4.0</h1>
            <p>Dashboard de Verificaci√≥n y Pruebas - Production Ready</p>
            <p>Base de datos: <strong>400,447 registros</strong> | Estado: <span id="server-status">Verificando...</span></p>
        </div>
        
        <div class="card">
            <h2>üìä Estado del Sistema</h2>
            <div id="system-status" class="loading">Verificando componentes del sistema</div>
        </div>
        
        <div class="card">
            <h2>üìà M√©tricas de Performance</h2>
            <div id="metrics-container" class="metrics">
                <div class="loading" style="grid-column: 1 / -1;">Cargando m√©tricas principales</div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="card">
                <h2>üìä Performance por Estados</h2>
                <div class="chart-container">
                    <canvas id="statesChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>üè¢ Top Sucursales</h2>
                <div class="chart-container">
                    <canvas id="branchesChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìà Tendencias Temporales</h2>
            <div class="chart-container">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>üß™ Pruebas de Endpoints API</h2>
            <div class="btn-group">
                <button onclick="testAllEndpoints()">üîÑ Probar Todos los Endpoints</button>
                <button onclick="loadDashboardData()">üìä Recargar Dashboard</button>
                <button onclick="testDifferentYears()">üìÖ Probar Diferentes A√±os</button>
                <button onclick="loadGeographicData()">üó∫Ô∏è Cargar Datos Geogr√°ficos</button>
            </div>
            <div id="api-tests"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5002';
        let charts = {};
        
        // Test system health
        async function checkSystemHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/health/detailed`);
                const data = await response.json();
                
                const statusDiv = document.getElementById('system-status');
                const serverStatus = document.getElementById('server-status');
                
                if (response.ok && data.status) {
                    serverStatus.innerHTML = `<span style="color: #28a745">‚úÖ ${data.status.toUpperCase()}</span>`;
                    
                    let componentStatus = '';
                    Object.entries(data.components).forEach(([name, component]) => {
                        const icon = component.status === 'healthy' ? '‚úÖ' : '‚ö†Ô∏è';
                        const statusClass = component.status === 'healthy' ? 'success' : 'warning';
                        
                        componentStatus += `
                            <div class="status ${statusClass}">
                                ${icon} <strong>${name.toUpperCase()}</strong>: ${component.status}
                                ${component.issues ? `<br><small>Issues: ${component.issues.join(', ')}</small>` : ''}
                            </div>
                        `;
                    });
                    
                    statusDiv.innerHTML = componentStatus;
                } else {
                    serverStatus.innerHTML = `<span style="color: #dc3545">‚ùå ERROR</span>`;
                    statusDiv.innerHTML = `<div class="status error">‚ùå Error del sistema: ${data.error || 'Unknown'}</div>`;
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML = `<span style="color: #dc3545">‚ùå OFFLINE</span>`;
                document.getElementById('system-status').innerHTML = 
                    `<div class="status error">‚ùå No se puede conectar al servidor: ${error.message}</div>`;
            }
        }
        
        // Load KPI metrics
        async function loadMetrics() {
            try {
                // Try different years to find data
                const yearsToTry = [2025, 2024, 2023, 2022, 2021, 2020];
                let data = null;
                let workingYear = null;
                
                for (const year of yearsToTry) {
                    try {
                        const response = await fetch(`${API_BASE}/api/v1/analytics/kpis?year=${year}&quarter=ALL`);
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success && result.data) {
                                data = result.data;
                                workingYear = year;
                                break;
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                const metricsContainer = document.getElementById('metrics-container');
                
                if (data && workingYear) {
                    metricsContainer.innerHTML = `
                        <div class="metric">
                            <div class="metric-value">${data.promedio_general ? data.promedio_general.toFixed(1) + '%' : 'N/A'}</div>
                            <div class="metric-label">Promedio General</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${(data.total_supervisiones || 0).toLocaleString()}</div>
                            <div class="metric-label">Total Supervisiones</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${(data.total_sucursales || 0).toLocaleString()}</div>
                            <div class="metric-label">Sucursales</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${data.total_estados || 0}</div>
                            <div class="metric-label">Estados</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${workingYear}</div>
                            <div class="metric-label">A√±o de Datos</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${data.cumplimiento_meta || 0}%</div>
                            <div class="metric-label">Cumplimiento Meta</div>
                        </div>
                    `;
                    
                    // Load charts with working year
                    loadPerformanceCharts(workingYear);
                } else {
                    metricsContainer.innerHTML = `
                        <div class="status warning" style="grid-column: 1 / -1;">
                            ‚ö†Ô∏è No se encontraron datos v√°lidos para los a√±os ${yearsToTry.join(', ')}<br>
                            Esto puede ser normal si los datos est√°n en diferentes per√≠odos.
                        </div>
                    `;
                    // Try to load charts anyway with default year
                    loadPerformanceCharts(2025);
                }
                
            } catch (error) {
                document.getElementById('metrics-container').innerHTML = 
                    `<div class="status error" style="grid-column: 1 / -1;">‚ùå Error cargando m√©tricas: ${error.message}</div>`;
            }
        }
        
        // Load performance charts
        async function loadPerformanceCharts(year) {
            // States performance chart
            try {
                const response = await fetch(`${API_BASE}/api/v1/analytics/performance/states?year=${year}&limit=10`);
                const data = await response.json();
                
                if (response.ok && data.success && data.data.length > 0) {
                    const ctx = document.getElementById('statesChart').getContext('2d');
                    
                    if (charts.states) charts.states.destroy();
                    
                    charts.states = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.data.map(item => item.estado),
                            datasets: [{
                                label: 'Performance Promedio (%)',
                                data: data.data.map(item => item.promedio),
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: `Performance por Estados - ${year}` }
                            },
                            scales: {
                                y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading states chart:', error);
            }
            
            // Branches performance chart
            try {
                const response = await fetch(`${API_BASE}/api/v1/analytics/performance/branches?year=${year}&limit=10`);
                const data = await response.json();
                
                if (response.ok && data.success && data.data.length > 0) {
                    const ctx = document.getElementById('branchesChart').getContext('2d');
                    
                    if (charts.branches) charts.branches.destroy();
                    
                    charts.branches = new Chart(ctx, {
                        type: 'horizontalBar',
                        data: {
                            labels: data.data.map(item => item.sucursal || 'N/A'),
                            datasets: [{
                                label: 'Performance (%)',
                                data: data.data.map(item => item.promedio),
                                backgroundColor: 'rgba(245, 87, 108, 0.8)',
                                borderColor: 'rgba(245, 87, 108, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: `Top Sucursales - ${year}` }
                            },
                            scales: {
                                x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading branches chart:', error);
            }
            
            // Trends chart
            try {
                const response = await fetch(`${API_BASE}/api/v1/analytics/trends?year=${year}`);
                const data = await response.json();
                
                if (response.ok && data.success && data.data.length > 0) {
                    const ctx = document.getElementById('trendsChart').getContext('2d');
                    
                    if (charts.trends) charts.trends.destroy();
                    
                    charts.trends = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.data.map(item => `Q${item.quarter}`),
                            datasets: [{
                                label: 'Promedio Trimestral (%)',
                                data: data.data.map(item => item.promedio),
                                borderColor: 'rgba(118, 75, 162, 1)',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: `Tendencias por Trimestre - ${year}` }
                            },
                            scales: {
                                y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading trends chart:', error);
            }
        }
        
        // Test all endpoints
        async function testAllEndpoints() {
            const testsDiv = document.getElementById('api-tests');
            testsDiv.innerHTML = '<div class="loading">Ejecutando pruebas completas de API</div>';
            
            const endpoints = [
                { url: '/api/v1/health', name: 'Health Check B√°sico' },
                { url: '/api/v1/health/detailed', name: 'Health Check Detallado' },
                { url: '/api/v1/analytics/kpis?year=2025&quarter=Q1', name: 'KPIs Q1 2025' },
                { url: '/api/v1/analytics/kpis?year=2025&quarter=ALL', name: 'KPIs Todo 2025' },
                { url: '/api/v1/geo/coordinates?year=2025&limit=5', name: 'Coordenadas Geogr√°ficas' },
                { url: '/api/v1/analytics/performance/states?year=2025', name: 'Performance Estados' },
                { url: '/api/v1/analytics/performance/branches?year=2025', name: 'Performance Sucursales' },
                { url: '/api/v1/analytics/trends?year=2025', name: 'Tendencias Temporales' },
                { url: '/api/v1/analytics/ranking?year=2025', name: 'Rankings' },
            ];
            
            let results = '';
            
            for (const endpoint of endpoints) {
                const testDiv = document.createElement('div');
                testDiv.className = 'endpoint-test';
                testDiv.innerHTML = `
                    <span class="endpoint-name">${endpoint.name}</span>
                    <span class="endpoint-status testing">Probando...</span>
                `;
                testsDiv.appendChild(testDiv);
                
                try {
                    const response = await fetch(`${API_BASE}${endpoint.url}`);
                    const statusSpan = testDiv.querySelector('.endpoint-status');
                    
                    if (response.ok) {
                        const data = await response.json();
                        statusSpan.className = 'endpoint-status success';
                        statusSpan.textContent = '‚úÖ OK';
                        
                        // Add data info
                        if (data.data && Array.isArray(data.data)) {
                            statusSpan.textContent += ` (${data.data.length} items)`;
                        } else if (data.data && typeof data.data === 'object') {
                            statusSpan.textContent += ' (datos v√°lidos)';
                        }
                    } else {
                        statusSpan.className = 'endpoint-status error';
                        statusSpan.textContent = `‚ùå ${response.status}`;
                    }
                } catch (error) {
                    const statusSpan = testDiv.querySelector('.endpoint-status');
                    statusSpan.className = 'endpoint-status error';
                    statusSpan.textContent = '‚ùå Error';
                }
            }
        }
        
        // Test different years
        async function testDifferentYears() {
            const testsDiv = document.getElementById('api-tests');
            testsDiv.innerHTML = '<div class="loading">Probando disponibilidad de datos por a√±o</div>';
            
            const years = [2025, 2024, 2023, 2022, 2021, 2020];
            let results = '<h3>üìÖ Disponibilidad de Datos por A√±o:</h3>';
            
            for (const year of years) {
                try {
                    const response = await fetch(`${API_BASE}/api/v1/analytics/kpis?year=${year}&quarter=ALL`);
                    const data = await response.json();
                    
                    if (response.ok && data.success && data.data && data.data.total_supervisiones > 0) {
                        results += `<div class="status success">‚úÖ ${year}: ${data.data.total_supervisiones.toLocaleString()} supervisiones, promedio ${data.data.promedio_general ? data.data.promedio_general.toFixed(1) : 'N/A'}%</div>`;
                    } else {
                        results += `<div class="status warning">‚ö†Ô∏è ${year}: Sin datos disponibles</div>`;
                    }
                } catch (error) {
                    results += `<div class="status error">‚ùå ${year}: Error de conexi√≥n</div>`;
                }
            }
            
            testsDiv.innerHTML = results;
        }
        
        // Load geographic data
        async function loadGeographicData() {
            const testsDiv = document.getElementById('api-tests');
            testsDiv.innerHTML = '<div class="loading">Cargando datos geogr√°ficos</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/geo/coordinates?year=2025&limit=20`);
                const data = await response.json();
                
                if (response.ok && data.success && data.data.length > 0) {
                    let geoInfo = `<h3>üó∫Ô∏è Datos Geogr√°ficos Encontrados:</h3>`;
                    geoInfo += `<div class="status success">‚úÖ ${data.data.length} coordenadas encontradas</div>`;
                    geoInfo += `<div class="status info">üìç Muestra de ubicaciones:</div>`;
                    
                    data.data.slice(0, 5).forEach(item => {
                        geoInfo += `<div class="status info">‚Ä¢ ${item.estado || 'N/A'}, ${item.sucursal || 'N/A'}: ${item.latitud}, ${item.longitud} (${item.porcentaje}%)</div>`;
                    });
                    
                    testsDiv.innerHTML = geoInfo;
                } else {
                    testsDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è No se encontraron datos geogr√°ficos</div>';
                }
            } catch (error) {
                testsDiv.innerHTML = `<div class="status error">‚ùå Error cargando datos geogr√°ficos: ${error.message}</div>`;
            }
        }
        
        // Load all dashboard data
        function loadDashboardData() {
            checkSystemHealth();
            loadMetrics();
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Falcon Miniapp Dashboard v4.0 iniciado');
            loadDashboardData();
        });
    </script>
</body>
</html>